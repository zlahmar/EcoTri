name: CI - EcoTri Workflow

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
      - develop

env:
  NODE_VERSION: '18'
  EXPO_VERSION: 'latest'

jobs:
  # Job de v√©rification de la qualit√© du code
  code-quality:
    name: Qualit√© du Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installer les d√©pendances
        run: npm ci --legacy-peer-deps

      - name: V√©rifier le lint TypeScript
        run: |
          echo "V√©rification du lint TypeScript..."
          npm run lint
          echo "Lint TypeScript r√©ussi"

      - name: V√©rifier les types TypeScript
        run: |
          echo "V√©rification des types TypeScript..."
          npm run type-check
          echo "Types TypeScript valides"

      - name: V√©rifier la couverture de code
        run: |
          echo "V√©rification de la couverture de code..."
          npm test -- --coverage --watchAll=false --passWithNoTests
          echo "Tests et couverture valid√©s"

  # Job de tests unitaires d√©taill√©s
  unit-tests:
    name: Tests Unitaires
    runs-on: ubuntu-latest
    needs: code-quality

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Installer les d√©pendances
        run: npm ci --legacy-peer-deps

      - name: Nettoyer le cache Jest
        run: |
          echo "Nettoyage du cache Jest..."
          npm test -- --clearCache
          echo "Cache Jest nettoy√©"

      - name: Lancer les tests unitaires
        run: |
          echo "Lancement des tests unitaires sur Node.js ${{ matrix.node-version }}..."
          npm test -- --coverage --watchAll=false --verbose --maxWorkers=1
          echo "Tests unitaires r√©ussis sur Node.js ${{ matrix.node-version }}"

      - name: Uploader les rapports de couverture
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Job de build et v√©rification Expo
  build-expo:
    name: Build Expo
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: heckout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installer les d√©pendances
        run: npm ci --legacy-peer-deps

      - name: Installer Expo CLI
        run: npm install -g @expo/cli@${{ env.EXPO_VERSION }}

      - name: V√©rifier la configuration Expo
        run: |
          echo "V√©rification de la configuration Expo..."
          npx expo-doctor
          echo "Configuration Expo valide"

      - name: Validation finale
        run: |
          echo "‚úÖ Toutes les v√©rifications sont pass√©es avec succ√®s !"
          echo "üì± Application mobile pr√™te pour le d√©ploiement"

  # Job de s√©curit√©
  security:
    name: S√©curit√©
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installer les d√©pendances
        run: npm ci --legacy-peer-deps

      - name: Audit de s√©curit√© npm
        run: |
          echo "Audit de s√©curit√© des d√©pendances..."
          npm audit --audit-level=moderate
          echo "Audit de s√©curit√© r√©ussi"

      - name: V√©rifier les vuln√©rabilit√©s avec Snyk
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

  # Job de notification
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [unit-tests, security]
    if: always()

    steps:
      - name: Notification de succ√®s
        if: success()
        run: |
          echo "Tous les tests sont pass√©s avec succ√®s !"
          echo "Qualit√© du code : OK"
          echo "Tests unitaires : OK"
          echo "S√©curit√© : OK"

      - name: Notification d'√©chec
        if: failure()
        run: |
          echo "Certains tests ont √©chou√©"
          echo "V√©rifiez les logs pour plus de d√©tails"
          exit 1

  # Job de d√©ploiement (optionnel)
  deploy:
    name: D√©ploiement
    runs-on: ubuntu-latest
    needs: [unit-tests, security]
    if: github.ref == 'refs/heads/master' && success()

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installer les d√©pendances
        run: npm ci --legacy-peer-deps

      - name: D√©ployer sur Expo (optionnel)
        run: |
          echo "D√©ploiement sur Expo..."
          # npx expo publish --non-interactive
          echo "D√©ploiement r√©ussi (simul√©)"
        continue-on-error: true

      - name: Cr√©er un badge de statut
        uses: schneegans/dynamic-badges-action@v1.6.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: your-gist-id
          filename: eco-tri-ci.json
          label: EcoTri CI
          message: ${{ job.status }}
          namedLogo: github
          color: ${{ job.status == 'success' && 'green' || 'red' }}
